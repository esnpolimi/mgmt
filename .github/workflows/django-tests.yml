name: Backend Tests (Tests)

on:
  pull_request:
    branches: [ "staging" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "development" ]

jobs:
  backend-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y default-libmysqlclient-dev build-essential pkg-config

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Create Django test settings
      run: |
        cat > backend/settings_test.py << 'EOF'
        import os
        from pathlib import Path
        import django
        from django.conf import settings

        # Base directory
        BASE_DIR = Path(__file__).resolve().parent

        # Security
        SECRET_KEY = os.environ.get('SECRET_KEY', 'django-insecure-test-key-only')
        DEBUG = True
        ALLOWED_HOSTS = ['*']

        # Database per test (SQLite in memoria - velocissimo)
        DATABASES = {
            'default': {
                'ENGINE': 'django.db.backends.sqlite3',
                'NAME': ':memory:',
            }
        }

        # Installed apps
        INSTALLED_APPS = [
            'django.contrib.admin',
            'django.contrib.auth',
            'django.contrib.contenttypes',
            'django.contrib.sessions',
            'django.contrib.messages',
            'django.contrib.staticfiles',
            "corsheaders",
            "rest_framework",
            'rest_framework_simplejwt',
            "users",
            "profiles",
            "treasury",
            "events",
            "content",
            'rest_framework_simplejwt.token_blacklist',
            'csp',
        ]

        # Middleware standard (aggiungi i tuoi se necessari)
        MIDDLEWARE = [
            'django.middleware.security.SecurityMiddleware',
            'django.contrib.sessions.middleware.SessionMiddleware',
            'django.middleware.common.CommonMiddleware',
            'django.middleware.csrf.CsrfViewMiddleware',
            'django.contrib.auth.middleware.AuthenticationMiddleware',
            'django.contrib.messages.middleware.MessageMiddleware',
            'django.middleware.clickjacking.XFrameOptionsMiddleware',
            'corsheaders.middleware.CorsMiddleware',
            'csp.middleware.CSPMiddleware'
        ]

        ROOT_URLCONF = 'backend.urls'

        # TEMPLATES
        TEMPLATES = [
            {
                'BACKEND': 'django.template.backends.django.DjangoTemplates',
                'DIRS': [],
                'APP_DIRS': True,
                'OPTIONS': {
                    'context_processors': [
                        'django.template.context_processors.debug',
                        'django.template.context_processors.request',
                        'django.contrib.auth.context_processors.auth',
                        'django.contrib.messages.context_processors.messages',
                    ],
                },
            },
        ]

        WSGI_APPLICATION = 'backend.wsgi.application'

        # Password validation (standard)
        AUTH_PASSWORD_VALIDATORS = [
            {
                'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
            },
            {
                'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
            },
            {
                'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
            },
            {
                'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
            },
        ]

        # Internationalization
        LANGUAGE_CODE = 'it-it'
        TIME_ZONE = 'Europe/Rome'
        USE_I18N = True
        USE_TZ = True

        # Static files
        STATIC_URL = '/static/'
        DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

        # Dummy per i tuoi servizi esterni
        GOOGLE_DRIVE_FOLDER_ID = 'dummy'
        SUMUP_CLIENT_ID = 'dummy'
        SUMUP_CLIENT_SECRET = 'dummy'
        SUMUP_WEBHOOK_SECRET = 'dummy'
        EOF

    - name: Run Backend Tests
      working-directory: backend
      env:
        DJANGO_SETTINGS_MODULE: backend.settings_test
        PYTHONPATH: ${{ github.workspace }}/backend
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
      run: |
        python manage.py test --verbosity=2
